window.storyFormat({
  "name": "Twine to Lua parser",
  "version": "0.0.16",
  "author": "SirBepy",
  "description": "Export your Twine 2 story as a lua file (RobloxStudio)",
  "proofing": false,
  "source": "<html>\r\n\r\n<head>\r\n  <title>{{STORY_NAME}}</title>\r\n  <script type=\"text/javascript\">\r\n    var{isArray:a}=Array,b={EXTRACT_PROPS:/\\$(?:(\\w+)\\.)?(\\w+)\\s*=\\s*(\"[^\"]+\"|'[^']+'|\\b\\w+\\b|\\d+)/,EXTRACT_CONDITION:/\\?\\((?:(\\w+)\\.)?(\\w+)\\s*(==|<|>)\\s*[\"']?([^\"'\\s]+)[\"']?\\)/,EXTRACT_EMOTION:/\\{\\{([\\w, +]+)\\}\\}/,IS_LINK:/^!*\\[\\[.+?\\]\\]!*$/g,DOUBLE_SQUARE_BRACKETS:/^!*\\[\\[|\\]\\]!*$/g};class Parser{twstory;constructor(A){this.twstory=A;this.convertPassage=this.convertPassage.bind(this)}toJSON(){console.log('Converting to Story //');var{name:_,startnode:B}=this.attrsToObject(this.twstory.attributes),c=this.twstory.getElementsByTagName('tw-passagedata'),d=[...c].map(this.convertPassage),e=d.find(C=>C.pid==B),f={};for(const _a of d)f[_a.name]={..._a};return{name:_,passages:f,startNode:e.name}}convertPassage(D){var _b=D.innerHTML.split('\\n').map(_A=>this.decodeHTMLEntities(_A).trim()).filter(Boolean).reduce((aA,_B)=>{const _C=_B.match(b.EXTRACT_PROPS),_D={},F=this.getCondition(_e),g=_e.match(b.EXTRACT_EMOTION),h=_e.match(b.IS_LINK);if(_C){aA.props=this.getProp(_C,aA.props);return aA}let _e=_B;F&&(_D.condition=F);_e=_e.replace(b.EXTRACT_CONDITION,'');g&&(_D.emotions=g[1].split(',').map(t=>t.trim()).filter(Boolean));_e=_e.replace(b.EXTRACT_EMOTION,'');if(h){const aB=_e.replace(b.DOUBLE_SQUARE_BRACKETS,'').split('|');if(aB&&aB.length==1){_D.text=null;_D.link=aB[0];aA.redirects.push(_D);return aA}if(aB&&aB.length==2){_D.text=aB[0];_D.link=aB[1];aA.responses.push(_D);return aA}return aA}_D.text=_e;aA.lines.push(_D);return aA},{lines:[],responses:[],redirects:[],props:{}}),{name:_c,pid:_d,tags:E}=this.attrsToObject(D.attributes);return{..._b,tags:E.split(' ').filter(Boolean),name:_c,pid:_d}}getProp(aD,aE){var[,aF,aG,_E]=aD;let _f;try {_f=JSON.parse(_E)} catch {_f=_E}aF?(aE[aF]=aE[aF]||{},aE[aF][aG]=_f):(aE[aG]=_f);return aE}getCondition(aH){var aI=aH.match(b.EXTRACT_CONDITION);if(!aI)return null;let[,aJ,aK,aL,_F]=aI;switch(aL) {case '==':aL='eq';break;case '>':aL='gt';break;case '<':aL='lt';break;case '>=':aL='gte';break;case '<=':aL='lte';break}try {_F=JSON.parse(_F)} catch {}return{group:aJ,prop:aK,comparator:aL,value:_F}}toLuaTableString(){var aM=aN=>{if(aN==null)return null;if(a(aN)){const aP=aN.map(aM).join(', ');return`{${aP}}`}const aO=typeof aN;if(aO=='number')return`${aN}`;if(aO=='string')return JSON.stringify(aN);if(aO=='object'){const aQ=Object.entries(aN).map(([aR,aS])=>`${aR} = ${aM(aS)}`).join(', ');return`{${aQ}}`}throw Error(`Unsupported data type: ${aO}`)};return`return ${aM(this.toJSON())}`}attrsToObject(aT){return Object.entries(aT).reduce((aU,[aV,aW])=>({...aU,[aW.name]:aW.value}),{})}decodeHTMLEntities(aX){var aY=document.createElement('textarea');aY.innerHTML=aX;return aY.value}}window.parseTwineToLua=()=>{var aZ=document.getElementsByTagName('tw-storydata')[0],bA=new Parser(aZ);document.getElementById('output').innerHTML=bA.toLuaTableString()};\r\n  </script>\r\n  <style>\r\n    body,\r\n    html {\r\n      box-sizing: border-box;\r\n      margin: 0;\r\n      padding: 0;\r\n      background-color: #365486;\r\n      color: #7FC7D9;\r\n    }\r\n\r\n    body {\r\n      display: flex;\r\n      flex-direction: column;\r\n      justify-content: center;\r\n      align-items: center;\r\n      height: 100%;\r\n    }\r\n\r\n    #storyData {\r\n      display: none;\r\n    }\r\n\r\n    #output {\r\n      width: 500px;\r\n      height: 500px;\r\n      max-width: 80vw;\r\n      max-height: 80vh;\r\n      overflow-y: auto;\r\n      text-wrap: wrap;\r\n      opacity: 0.5;\r\n      padding: 1em;\r\n      border: #0F1035 4px solid;\r\n      border-radius: 10px;\r\n    }\r\n\r\n    button {\r\n      width: 180px;\r\n      height: 40px;\r\n      border-radius: 10px;\r\n      font-size: 1.2em;\r\n      background-color: #7FC7D9;\r\n      color: white;\r\n      border: #DCF2F1 1px solid;\r\n      transition: 0.2s;\r\n      cursor: pointer;\r\n    }\r\n\r\n    button:hover {\r\n      opacity: 0.5;\r\n    }\r\n\r\n    button:active {\r\n      opacity: 0.2;\r\n    }\r\n\r\n    button:disabled {\r\n      opacity: 1;\r\n    }\r\n  </style>\r\n</head>\r\n\r\n<body>\r\n  <button onclick=\"copyText(this)\">Copy output</button>\r\n  <pre id=\"output\"></pre>\r\n  <div id=\"storyData\">\r\n    {{STORY_DATA}}\r\n  </div>\r\n  <script>\r\n    function copyText() {\r\n      const textToCopy = document.getElementById(\"output\").innerText;\r\n      const textarea = document.createElement(\"textarea\");\r\n      textarea.value = textToCopy;\r\n\r\n      document.body.appendChild(textarea);\r\n      textarea.select();\r\n      document.execCommand('copy');\r\n      document.body.removeChild(textarea);\r\n\r\n      const button = document.querySelector('button');\r\n      button.textContent = 'Copied to clipboard';\r\n      button.disabled = true\r\n\r\n      setTimeout(() => {\r\n        button.textContent = 'Copy output';\r\n        button.disabled = false\r\n      }, 1500);\r\n    }\r\n    parseTwineToLua();\r\n  </script>\r\n</body>\r\n\r\n</html>\r\n"
});